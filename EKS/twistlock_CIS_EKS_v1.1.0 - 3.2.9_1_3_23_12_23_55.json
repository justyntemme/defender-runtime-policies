{"modified":"2022-12-21T05:02:03.157Z","owner":"rsingh3@paloaltonetworks.com","name":"CIS_EKS_v1.1.0 - 3.2.9","previousName":"","_id":9014,"title":"Ensure that the --eventRecordQPS argument is set to 0 or a level which ensures appropriate event capture","script":"function parse_yaml {\n   local prefix=$2\n   local s='[[:space:]]*' w='[a-zA-Z0-9_]*' fs=$(echo @|tr @ '\\034')\n   sed -ne \"s|^\\($s\\):|\\1|\" \\\n        -e \"s|^\\($s\\)\\($w\\)$s:$s[\\\"']\\(.*\\)[\\\"']$s\\$|\\1$fs\\2$fs\\3|p\" \\\n        -e \"s|^\\($s\\)\\($w\\)$s:$s\\(.*\\)$s\\$|\\1$fs\\2$fs\\3|p\"  $1 |\n   awk -F$fs '{\n      indent = length($1)/2;\n      vname[indent] = $2;\n      for (i in vname) {if (i > indent) {delete vname[i]}}\n      if (length($3) > 0) {\n         vn=\"\"; for (i=0; i<indent; i++) {vn=(vn)(vname[i])(\"_\")}\n         printf(\"%s%s%s=%s\\n\", \"'$prefix'\",vn, $2, $3);\n      }\n   }'\n}\n\nevent_record_arg=$(ps -ef | grep kubelet | grep -o '\\-\\-eventRecordQPS=[^ ]*' | cut -d= -f2)\nif [ -n \"$event_record_arg\" ]; then\n    if [ $event_record_arg -ge 0 ]; then\n        exit 0\n    else\n        echo \"EKS CIS 3.2.9 - Ensure that eventRecordQPS argument is set to 5 or a value equal or greater than 0\"\n        exit 1\n    fi\nelif [ -z \"$event_record_arg\" ]; then\n    event_record_arg=$(ps -ef | grep kubelet | grep -o '\\-\\-eventRecordQPS [^ ]*' | cut -d' ' -f2)\n    if [ -n \"$event_record_arg\" ]; then\n      if [ $event_record_arg -ge 0 ]; then\n        exit 0\n      else\n        echo \"EKS CIS 3.2.9 - Ensure that eventRecordQPS argument is set to 5 or a value equal or greater than 0\"\n        exit 1\n      fi  \n    fi\nfi\n\nfile_path=$(ps -ef | grep kubelet | grep -o '\\-\\-config=[^ ]*' | cut -d= -f2)\nif [ -z $file_path ]; then\n    file_path=$(ps -ef | grep kubelet | grep -o '\\-\\-config [^ ]*' | cut -d' ' -f2)\n    if [ -z $file_path ]; then\n        echo \"File Not Found\"\n        exit 1\n    fi\nfi\n\nif [ -f $file_path ]; then\n  if [[ $file_path == *\"yaml\"* ]]; then\n    data=$(parse_yaml $file_path)\n    event_record_qps=$(grep \"^eventRecordQPS=\" <<< \"$data\" | cut -d= -f2-)\n    if [ -z $event_record_qps ]; then\n        echo \"CIS EKS 3.2.9 - Ensure that eventRecordQPS is set to 5 or a value equal or greater than 0 in the kubelet config file\"\n        exit 1\n    fi\n  elif [[ $file_path == *\"json\"* ]]; then\n    event_record_qps=$(jq '.eventRecordQPS' $file_path)\n    if [ $event_record_qps == null ]; then \n        echo \"CIS EKS 3.2.9 - Ensure that eventRecordQPS is set to 5 or a value equal or greater than 0 in the kubelet config file\"\n        exit 1\n    fi\n  fi\n  if [ $event_record_qps -ge 0 ]; then\n    exit 0\n  else\n    echo \"EKS CIS 3.2.9 - Ensure that eventRecordQPS is set to 5 or a value equal or greater than 0 in the kubelet config file\"\n    exit 1\n  fi\nfi","severity":"medium"}